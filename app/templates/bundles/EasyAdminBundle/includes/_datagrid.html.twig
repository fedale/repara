{% block main %}
    {# sort can be multiple; let's consider the sorting field the first one #}
    {% set sort_field_name = app.request.get('sort')|keys|first %}
    {% set sort_order = app.request.get('sort')|first %}
    {% set some_results_are_hidden = entities|reduce((some_results_are_hidden, entity) => some_results_are_hidden or not entity.isAccessible, false) %}
    {% set has_footer = entities|length != 0 %}
    {% set has_search = ea.crud.isSearchEnabled %}
    {% set has_filters = filters|length > 0 %}
    {% set num_results = entities|length %}

{{ dump(ea.search) }}
<div class="card">
    <div class="card-body border-bottom py-3">
      <div class="d-flex justify-content-between">
        <div class="content-search mr-auto">
            {% if has_search %}
                {% block search %}

                    <form class="form-action-search" method="get">
                        {% block search_form %}
                            {% block search_form_filters %}
                                {% for field, array in ea.search.appliedFilters %}
                                    {% for key, value in array %}
                                        {# This code re-applies your filters on searches, an iterable check is needed in cases we have more than one object for a filter #}
                                        {% if value is iterable %}
                                            {% for index, iterValue in value %}
                                                {# This sub-level iterable check is needed in cases we have more complex filters like the DateTimeFilter cf. issue #5038 #}
                                                {% if iterValue is iterable %}
                                                    {% for subIndex, subIterValue in iterValue %}
                                                        <input type="hidden" name="filters[{{ field }}][{{ key }}][{{ index }}][{{ subIndex }}]" value="{{ subIterValue }}">
                                                    {% endfor %}
                                                {% else %}
                                                    <input type="hidden" name="filters[{{ field }}][{{ key }}][{{ index }}]" value="{{ iterValue }}">
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <input type="hidden" name="filters[{{ field }}][{{ key }}]" value="{{ value }}">
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                            {% endblock %}

                            <input type="hidden" name="crudAction" value="index">
                            <input type="hidden" name="crudControllerFqcn" value="{{ ea.request.query.get('crudControllerFqcn') }}">
                            <input type="hidden" name="menuIndex" value="{{ ea.request.query.get('menuIndex') }}">
                            <input type="hidden" name="submenuIndex" value="{{ ea.request.query.get('submenuIndex') }}">
                            <input type="hidden" name="page" value="1">

                            <div class="form-group">
                                <div class="input-icon">
                                        <input 
                                            class="form-control {{ app.request.get('query') is null ? 'is-blank' }}" 
                                            type="search" 
                                            name="query" 
                                            value="{{ app.request.get('query') ?? '' }}" 
                                            placeholder="{{ t('action.search', ea.i18n.translationParameters, 'EasyAdminBundle')|trans }}" 
                                            spellcheck="false" 
                                            autocorrect="off" 
                                            onInput="this.parentNode.dataset.value=this.value"{% if ea.crud.currentAction == 'index' and ea.crud.autofocusSearch == true %} 
                                            autofocus="autofocus"{% endif %}
                                        >
                                        <span class="input-icon-addon">
                                        {% if app.request.get('query') %}
                                            <a href="{{ ea_url().unset('query') }}" class="content-search-reset">
                                                <i class="fas fa-fw fa-times"></i>
                                            </a>
                                        {% else %}
                                            <i class="fas fa-search content-search-icon"></i>
                                        {% endif %}
                                    </span>

                                    
                                </div>
                            </div>
                        {% endblock %}
                    </form>
                {% endblock search %}
            {% endif %}
        </div>

            {% block page_actions %}
                <div class="page_actions">
                {% if filters|length > 0 %}
                    <div class="datagrid-filters d-inline-block">
                        {% block filters %}
                            {% set applied_filters = ea.request.query.all['filters']|default([])|keys %}
                            <div class="btn-group action-filters">
                                <a href="#" data-href="{{ ea_url().setAction('renderFilters').includeReferrer() }}" class="btn btn-secondary btn-labeled btn-labeled-right action-filters-button disabled {{ applied_filters ? 'action-filters-applied' }}" data-bs-toggle="modal" data-bs-target="#modal-filters">
                                    <i class="fa fa-filter fa-fw"></i> {{ t('filter.title', ea.i18n.translationParameters, 'EasyAdminBundle')|trans }}{% if applied_filters %} <span class="action-filters-button-count">({{ applied_filters|length }})</span>{% endif %}
                                </a>
                                {% if applied_filters %}
                                    <a href="{{ ea_url().unset('filters') }}" class="btn btn-secondary action-filters-reset">
                                        <i class="fa fa-close"></i>
                                    </a>
                                {% endif %}
                            </div>
                        {% endblock filters %}
                    </div>
                {% endif %}

                {% block global_actions %}
                    <div class="global-actions d-inline-block">
                        {% for action in global_actions %}
                            {{ include(action.templatePath, { action: action }, with_context = false) }}
                        {% endfor %}
                    </div>
                {% endblock global_actions %}

                {% block batch_actions %}
                    {% if has_batch_actions %}
                        <div class="batch-actions" style="display: none">
                            {% for action in batch_actions %}
                                {{ include(action.templatePath, { action: action }, with_context = false) }}
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endblock %}
                </div>
            {% endblock page_actions %}
        </div>
    </div><!-- .card-body -->

    <div class="table-responsive">
    
        <table class="table card-table table-vcenter text-nowrap datatable {{ entities is empty ? 'datagrid-empty' }}">
            {% if num_results > 0 %}
                <thead>
                {% block table_head %}
                    <tr>
                        {% if has_batch_actions %}
                            <th>
                            <div class="form-check btn-group dropdown-center">
                            <button type="button" class="btn btn-sm btn-secondary" style="background-color: rgb(0 0 0 / 0%); box-shadow: none">
                                <span style="padding:0"><input type="checkbox" class="form-check-input form-batch-checkbox-all"></span>
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false" style="background-color: rgb(0 0 0 / 0%); ; box-shadow: none;">
                                <span class="visually-hidden">Toggle Dropdown</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item form-batch-checkbox-all" href="#">All</a></li>
                                <li><a class="dropdown-item" href="#">None</a></li>
                                <li><a class="dropdown-item" href="#">Inverse</a></li>
                            </ul>
                            </div>
                            </th>
                        {% endif %}

                        {% set ea_sort_asc = constant('EasyCorp\\Bundle\\EasyAdminBundle\\Config\\Option\\SortOrder::ASC') %}
                        {% set ea_sort_desc = constant('EasyCorp\\Bundle\\EasyAdminBundle\\Config\\Option\\SortOrder::DESC') %}
                        
                        {% for field in entities|first.fields ?? [] %}
                        {# {{ form_widget(field) }} #}
                            {% set is_sorting_field = ea.search.isSortingField(field.property) %}
                            {% set next_sort_direction = is_sorting_field ? (ea.search.sortDirection(field.property) == ea_sort_desc ? ea_sort_asc : ea_sort_desc) : ea_sort_desc %}
                            {% set column_icon = is_sorting_field ? (next_sort_direction == ea_sort_desc ? 'fa-arrow-up' : 'fa-arrow-down') : 'fa-sort' %}

                            <th class="{{ is_sorting_field ? 'sorted' }} {{ field.isVirtual ? 'field-virtual' }} header-for-{{ field.cssClass|split(' ')|filter(class => class starts with 'field-')|join('') }} text-{{ field.textAlign }}" dir="{{ ea.i18n.textDirection }}">
                                {% if field.isSortable %}
                                    <a href="{{ ea_url({ page: 1, sort: { (field.property): next_sort_direction } }).includeReferrer() }}">
                                        {{ field.label|trans|raw }} <i class="fa fa-fw {{ column_icon }}"></i>
                                    </a>
                                {% else %}
                                    <span>{{ field.label|trans|raw }}</span>
                                {% endif %}
                            </th>
                        {% endfor %}

                        <th {% if ea.crud.showEntityActionsAsDropdown %}style="width: 10px"{% endif %} dir="{{ ea.i18n.textDirection }}">
                            <span class="sr-only">{{ t('action.entity_actions', ea.i18n.translationParameters, 'EasyAdminBundle')|trans }}</span>
                        </th>
                    </tr>
                
                {% endblock table_head %}

                {% block table_filter %}
                    <tr>
                        <th>
                        First cell is empty
                        </th>
                        {% for field in entities|first.fields ?? [] %}
                        {# {{ form_widget(field) }} #}
                            <th class="">
                                {# {{ form_widget(field) }} #}
                                {# {{ dump(field) }} #}
                            </th>
                        {% endfor %}
                        <th>
                            <span class="">Last cell is empty!</span>
                        </th>
                    </tr>   
                {% endblock table_filter %}

                </thead>
            {% endif %}

            <tbody>
            {% block table_body %}
                {% for entity in entities %}
                    {% if entity.isAccessible %}
                        <tr data-id="{{ entity.primaryKeyValueAsString }}">
                            {% if has_batch_actions %}
                                <td class="batch-actions-selector">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input form-batch-checkbox" value="{{ entity.primaryKeyValue }}">
                                    </div>
                                </td>
                            {% endif %}

                            {% for field in entity.fields %}
                                <td data-label="{{ field.label|trans|e('html_attr') }}" class="{{ field.property == sort_field_name ? 'sorted' }} text-{{ field.textAlign }} {{ field.cssClass }}" dir="{{ ea.i18n.textDirection }}">
                                    {{ include(field.templatePath, { field: field, entity: entity }, with_context = false) }}
                                </td>
                            {% endfor %}

                            {% block entity_actions %}
                                <td class="actions {{ ea.crud.showEntityActionsAsDropdown ? 'actions-as-dropdown' }}">
                                    {% if entity.actions.count > 0 %}
                                        {% if ea.crud.showEntityActionsAsDropdown %}
                                            <div class="dropdown dropdown-actions">
                                                <a class="dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                    {# don't use FontAwesome 'fa-ellipsis-h' icon here because it doesn't look good #}
                                                    {# this icon is 'dots-horizontal' icon from https://heroicons.com/ #}
                                                    <svg xmlns="http://www.w3.org/2000/svg" height="21" width="21" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
                                                    </svg>
                                                </a>

                                                <div class="dropdown-menu dropdown-menu-right">
                                                    {% for action in entity.actions %}
                                                        {{ include(action.templatePath, { action: action, entity: entity, isIncludedInDropdown: ea.crud.showEntityActionsAsDropdown }, with_context = false) }}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% else %}
                                            {% for action in entity.actions %}
                                                {{ include(action.templatePath, { action: action, entity: entity, isIncludedInDropdown: ea.crud.showEntityActionsAsDropdown }, with_context = false) }}
                                            {% endfor %}
                                        {% endif %}
                                    {% endif %}
                                </td>
                            {% endblock entity_actions %}
                        </tr>

                    {% endif %}
                {% else %}
                    {% block table_body_empty %}
                        {% for i in 1..14 %}
                            <tr class="empty-row">
                                <td><span></span></td>
                                <td><span></span></td>
                                <td><span></span></td>
                                <td><span></span></td>
                                <td><span></span></td>
                                <td><span></span></td>
                            </tr>

                            {% if 3 == loop.index %}
                                <tr class="no-results">
                                    <td colspan="100">
                                        {{ t('datagrid.no_results', ea.i18n.translationParameters, 'EasyAdminBundle')|trans }}
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% endblock table_body_empty %}
                {% endfor %}

                {% if some_results_are_hidden %}
                    <tr class="datagrid-row-empty">
                        <td class="text-center" colspan="100">
                            <span class="datagrid-row-empty-message"><i class="fa fa-lock mr-1"></i> {{ 'datagrid.hidden_results'|trans({}, 'EasyAdminBundle') }}</span>
                        </td>
                    </tr>
                {% endif %}
            {% endblock table_body %}
            </tbody>

            <tfoot>
            {% block table_footer %}
            {% endblock table_footer %}
            </tfoot>
        </table>
    
    </div><!-- .table-responsive -->

    <div class="card-footer d-flex align-items-center">
        {% if entities|length > 0 %}
                {% block paginator %}
                    {{ include(ea.templatePath('crud/paginator'), { render_detailed_pagination: not some_results_are_hidden }) }}
                {% endblock paginator %}
        {% endif %}
    </div><!-- .card-footer -->

</div><!-- .card -->    

    {% block delete_form %}
        {{ include('@EasyAdmin/crud/includes/_delete_form.html.twig', with_context = false) }}
    {% endblock delete_form %}
   
    {% if has_filters %}
                    {{ include('@EasyAdmin/crud/includes/_filters_modal.html.twig') }}
    {% endif %}

    {% if has_batch_actions %}
        {{ include('@EasyAdmin/crud/includes/_batch_action_modal.html.twig', {}, with_context = false) }}
    {% endif %}

{% endblock main %}
